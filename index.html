<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carpe Diem – Stock Simulator</title>
  <style>
    :root{
      --bg:#0b132b;
      --panel:#14213d;
      --card:#1b294a;
      --accent:#4cafef;
      --accent-2:#357abd;
      --text:#ffffff;
      --muted:#eef4ff;
      --muted-2:#d7e3ff;
      --good:#3ddc97;
      --bad:#ff6b6b;
      --border:#ffffff33;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      background:var(--bg); color:var(--text);
    }
    header{
      background:linear-gradient(90deg,#0e1a34,#18335f);
      padding:14px 16px; text-align:center; font-weight:800; letter-spacing:.3px;
      box-shadow:0 2px 14px #0008;
    }
    .wrap{max-width:1160px;margin:24px auto;padding:0 16px}
    .hidden{display:none !important}
    .panel{
      background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:0 6px 24px #0006;
    }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:0 4px 18px #0005;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px; border-radius:10px; border:1px solid transparent;
      font-weight:700; cursor:pointer; transition:.18s ease;
    }
    .btn-primary{ background:var(--accent); color:#041426 }
    .btn-primary:hover{ background:var(--accent-2) }
    .btn-ghost{ background:transparent; border-color:var(--border); color:var(--text) }
    .btn-ghost:hover{ background:#ffffff14 }
    /* Login */
    .login-shell{ min-height:70vh; display:grid; place-items:center; }
    .login-box{ width:min(480px,100%); padding:28px }
    .input{
      width:100%; padding:12px 14px; border-radius:10px; border:1px solid var(--border);
      background:#0e1a34; color:#fff;
    }
    .input::placeholder{ color:#f0f5ff }
    label{ font-size:.9rem; color:var(--muted); margin-bottom:6px; display:inline-block }
    /* Grid */
    .grid{ display:grid; gap:16px }
    .grid-3{ grid-template-columns:repeat(3,1fr) }
    @media (max-width:960px){ .grid-3{ grid-template-columns:repeat(2,1fr) } }
    @media (max-width:640px){ .grid-3{ grid-template-columns:1fr } }
    /* Stock tiles */
    .tile{
      padding:12px; border-radius:12px; border:1px solid var(--border); background:#0f1c37;
      cursor:pointer; transition:transform .12s ease, border-color .12s ease;
    }
    .tile:hover{ transform:translateY(-1px); border-color:#ffffff55 }
    .tile .name{ font-weight:800; color:#fff }
    .tile .price{ color:#fff; margin-top:2px; font-weight:800 }
    /* Metrics row */
    .metrics{ display:grid; grid-template-columns:repeat(3,1fr); gap:14px }
    @media (max-width:700px){ .metrics{ grid-template-columns:1fr } }
    .metric{
      padding:14px; border-radius:12px; border:1px solid var(--border); background:#0f1c37; text-align:center;
    }
    .metric .label{ font-size:.85rem; color:var(--muted-2); letter-spacing:.02em }
    .metric .value{ font-size:1.6rem; font-weight:800; margin-top:6px; color:#fff }
    /* Details */
    .details{ display:grid; grid-template-columns:2fr 1fr; gap:16px }
    @media (max-width:900px){ .details{ grid-template-columns:1fr } }
    canvas{ width:100%; height:220px; background:#0b1730; border:1px solid var(--border); border-radius:12px }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .spacer{ flex:1 }
    .muted{ color:var(--muted) }
    hr.sep{ border:none; height:1px; background:var(--border); margin:10px 0 }
    table{ width:100%; border-collapse:separate; border-spacing:0 8px }
    th,td{ text-align:left; padding:8px 10px; color:#fff }
    th{ color:#e9f1ff; font-weight:800; border-bottom:1px solid var(--border) }
    tr.data{ background:#0f1c37; border:1px solid var(--border) }
    tr.data td{ border-top:1px solid var(--border); border-bottom:1px solid var(--border) }
    small.err{ color:#ffd0d0 }
  </style>
</head>
<body>
  <header>Carpe Diem – Stock Simulator</header>

  <main class="wrap">
    <section id="loginSection" class="panel login-shell">
      <form id="loginForm" class="login-box card" autocomplete="on" novalidate>
        <h2 style="margin:0 0 14px 0">Sign in</h2>
        <div class="grid">
          <div>
            <label for="email">Email</label>
            <input id="email" type="email" class="input" placeholder="name@gsis.ac.in" required />
          </div>
          <div>
            <label for="password">Password</label>
            <input id="password" type="password" class="input" placeholder="••••••••" required />
          </div>
          <div class="row" style="margin-top:4px">
            <button id="loginBtn" class="btn btn-primary" type="button">Log in</button>
            <span id="loginError" class="muted" style="margin-left:8px"></span>
          </div>
        </div>
      </form>
    </section>

    <section id="dashboard" class="hidden">

      <div class="panel" style="padding:12px 14px; display:flex; align-items:center; gap:10px; flex-wrap:wrap">
        <strong id="roleHeader">Welcome</strong>
        <span class="spacer"></span>
        <button id="logoutBtn" class="btn btn-ghost">Log out</button>
      </div>

      <div id="traderMetrics" class="metrics hidden" style="margin:16px 0">
        <div class="metric">
          <div class="label">Working Capital</div>
          <div class="value">₹<span id="workingCap">0.00</span></div>
        </div>
        <div class="metric">
          <div class="label">Invested Capital</div>
          <div class="value">₹<span id="investedCap">0.00</span></div>
        </div>
        <div class="metric">
          <div class="label">Profit / Loss</div>
          <div class="value" id="profitLoss">0.00%</div>
        </div>
      </div>

      <div class="panel" style="padding:16px">
        <div class="row" style="margin-bottom:10px">
          <h3 style="margin:0">Stocks</h3>
          <span class="spacer"></span>
        </div>
        <div id="stockList" class="grid grid-3"></div>
      </div>

      <section class="details" style="margin-top:16px">
        <div class="panel" style="padding:16px">
          <div class="row">
            <h3 id="detailName" style="margin:0">Select a stock</h3>
            <span class="spacer"></span>
            <div id="detailPrice" class="muted"></div>
          </div>

          <canvas id="chart" width="900" height="220"></canvas>
          <div id="chartTypeRow" class="row hidden" style="margin-top:10px; justify-content:flex-end">
             <label class="muted">Chart Type:</label>
             <button id="lineGraphBtn" class="btn btn-primary">Line</button>
             <button id="candleGraphBtn" class="btn btn-ghost">Candle</button>
          </div>


          <div id="tradeBar" class="row" style="margin-top:10px">
            <label for="qty" class="muted">Qty</label>
            <input id="qty" class="input" type="number" min="1" value="1" style="width:120px" />
            <button id="buyBtn" class="btn btn-primary">Buy</button>
            <button id="sellBtn" class="btn btn-ghost">Sell</button>
            <span id="tradeMsg" class="muted"></span>
          </div>

          <div id="autoRow" class="row" style="margin-top:10px">
            <label for="autoPrice" class="muted">Auto-sell at price</label>
            <input id="autoPrice" class="input" type="number" min="0" placeholder="e.g. 1200" style="width:160px" />
            <input id="autoQty" class="input" type="number" min="1" placeholder="qty" style="width:120px" />
            <button id="setAutoBtn" class="btn btn-primary">Set Auto-Sell</button>
            <button id="clearAutoBtn" class="btn btn-ghost">Clear</button>
            <span id="autoMsg" class="muted"></span>
          </div>

          <div id="adminPortfolioView" class="hidden">
            <h3 style="margin:14px 0 8px 0">View Trader Portfolio</h3>
            <div class="row" style="margin-bottom:8px">
              <select id="traderSelect" class="input" style="max-width:420px;"></select>
            </div>
            <div id="portfolioWrap" class="card" style="padding:10px; display:none">
              <h4 id="pfTitle" style="margin:6px 0">Portfolio</h4>
              <div class="row muted" id="pfSummary"></div>
              <table style="margin-top:6px">
                <thead><tr><th>Stock</th><th>Qty</th><th>Price</th><th>Value</th></tr></thead>
                <tbody id="pfTable"></tbody>
              </table>

              <h4 style="margin:12px 0 6px 0">Trade History</h4>
              <div id="historyWrap" class="card" style="padding:8px; max-height:240px; overflow:auto">
                <table style="width:100%">
                  <thead><tr><th>Time</th><th>Action</th><th>Stock</th><th>Qty</th><th>Price</th><th>Value</th></tr></thead>
                  <tbody id="historyTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="panel" style="padding:16px">
          <div id="traderSide" class="hidden">
            <h3 style="margin-top:0">My Portfolio</h3>
            <div class="card" style="padding:10px; max-height:260px; overflow:auto">
              <div id="traderPfSummary" class="row muted" style="margin-bottom:6px"></div>
              <table>
                <thead><tr><th>Stock</th><th>Qty</th><th>Price</th><th>Value</th></tr></thead>
                <tbody id="traderPfTable"></tbody>
              </table>
            </div>
          </div>

          <div id="adminSide">
            <h3 style="margin-top:0">Admin</h3>
            <div id="adminOnlyHint" class="muted">Only visible for admins</div>
            <div id="adminControls" class="hidden">
              <div class="row" style="align-items:baseline">
                <label class="muted" style="margin-right:6px">Selected stock:</label>
                <strong id="adminSelected" style="font-weight:800">None</strong>
                <span class="muted" id="adminSelectedPrice" style="margin-left:6px"></span>
              </div>

              <div class="row" style="margin-top:8px">
                <label class="muted">Adjust selected stock</label>
              </div>
              <div class="row">
                <button id="raiseBtn" class="btn btn-primary">Increase 10%</button>
                <button id="lowerBtn" class="btn btn-ghost">Decrease 10%</button>
                <button id="raise50Btn" class="btn btn-primary">Increase 50%</button>
                <button id="lower50Btn" class="btn btn-ghost">Decrease 50%</button>
              </div>
               <div class="row" style="margin-top:10px">
                <button id="freezeBtn" class="btn btn-ghost" style="border-color:#ff6b6b;color:#ff6b6b">Freeze Selected</button>
                <button id="unfreezeBtn" class="btn btn-primary">Unfreeze Selected</button>
                <span id="freezeMsg" class="muted"></span>
              </div>

              <hr class="sep" />
              <div class="row" style="margin-top:10px">
                  <label class="muted">All Stocks Control</label>
              </div>
              <div class="row">
                  <button id="freezeAllBtn" class="btn btn-ghost" style="border-color:#ff6b6b;color:#ff6b6b">Freeze All</button>
                  <button id="unfreezeAllBtn" class="btn btn-primary">Unfreeze All</button>
                  <span id="allFreezeMsg" class="muted"></span>
              </div>

              <hr class="sep" />
              <div class="row">
                <label class="muted">Set starting funds for ALL traders</label>
              </div>
              <div class="row">
                <input id="allFunds" class="input" type="number" min="0" placeholder="e.g. 100000" style="width:180px" />
                <button id="applyFundsBtn" class="btn btn-primary">Apply</button>
                <span id="fundsMsg" class="muted"></span>
              </div>

              <hr class="sep" />
              <button id="resetBtn" class="btn btn-ghost" style="border-color:#ffc107;color:#ffc107;width:100%">⚠ Hard RESET (All Traders + Stocks)</button>

              <hr class="sep" />
              <h4 style="margin:6px 0">Trader Rankings</h4>
              <div id="rankWrap" class="card" style="padding:10px; max-height:260px; overflow:auto">
                <table>
                  <thead><tr><th>#</th><th>Trader</th><th>Total Equity</th><th>P/L</th></tr></thead>
                  <tbody id="rankTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, onSnapshot, query, where, runTransaction } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyC72GZrrjG4UIR3qzDs-I2QWIgSFd4Yehs",
      authDomain: "carpediem-f6948.firebaseapp.com",
      projectId: "carpediem-f6948",
      storageBucket: "carpediem-f6948.firebasestorage.app",
      messagingSenderId: "705608113463",
      appId: "1:705608113463:web:eb70088734b33486c70eb2"
    };
    const APP_ID = "carpe_diem";
    const app = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);

    (async () => {
      try { await setPersistence(auth, browserSessionPersistence); }
      catch(e){ console.warn("Auth persistence not set:", e?.message||e); }
    })();

    const $ = (id)=>document.getElementById(id);
    const loginSection = $("loginSection");
    const loginBtn     = $("loginBtn");
    const loginError   = $("loginError");
    const dashboard    = $("dashboard");
    const roleHeader   = $("roleHeader");
    const logoutBtn    = $("logoutBtn");

    loginBtn.addEventListener("click", async (e)=>{
      e.preventDefault();
      loginError.textContent = "";
      loginBtn.disabled = true;
      loginBtn.textContent = "Logging in…";
      const email = $("email").value.trim();
      const pass  = $("password").value.trim();
      try{
        await signInWithEmailAndPassword(auth, email, pass);
      }catch(err){
        loginError.innerHTML = `<small class="err">${err.message}</small>`;
      }finally{
        loginBtn.disabled = false;
        loginBtn.textContent = "Log in";
      }
    });

    logoutBtn.addEventListener("click", async ()=>{
      try{ await signOut(auth); }catch(_){}
      location.reload();
    });

    const traderMetrics = $("traderMetrics");
    const workingCapEl  = $("workingCap");
    const investedCapEl = $("investedCap");
    const profitLossEl  = $("profitLoss");

    const stockList = $("stockList");
    const detailName  = $("detailName");
    const detailPrice = $("detailPrice");
    const chartEl     = $("chart");
    const chartTypeRow= $("chartTypeRow");
    const qtyEl       = $("qty");
    const tradeMsg    = $("tradeMsg");
    const tradeBar    = $("tradeBar");
    const adminPortfolioView = $("adminPortfolioView");

    const autoPrice   = $("autoPrice");
    const autoQty     = $("autoQty");
    const setAutoBtn  = $("setAutoBtn");
    const clearAutoBtn= $("clearAutoBtn");
    const autoMsg     = $("autoMsg");

    const adminSide     = $("adminSide");
    const adminOnlyHint = $("adminOnlyHint");
    const adminControls = $("adminControls");
    const raiseBtn      = $("raiseBtn");
    const lowerBtn      = $("lowerBtn");
    const raise50Btn    = $("raise50Btn");
    const lower50Btn    = $("lower50Btn");
    const allFunds      = $("allFunds");
    const applyFundsBtn = $("applyFundsBtn");
    const fundsMsg      = $("fundsMsg");
    const rankTable     = $("rankTable");
    const traderSelect  = $("traderSelect");
    const portfolioWrap = $("portfolioWrap");
    const pfTitle       = $("pfTitle");
    const pfSummary     = $("pfSummary");
    const pfTable       = $("pfTable");
    const adminSelected = $("adminSelected");
    const adminSelectedPrice = $("adminSelectedPrice");

    const freezeBtn   = $("freezeBtn");
    const unfreezeBtn = $("unfreezeBtn");
    const freezeMsg   = $("freezeMsg");
    const freezeAllBtn = $("freezeAllBtn");
    const unfreezeAllBtn = $("unfreezeAllBtn");
    const allFreezeMsg = $("allFreezeMsg");

    const traderSide      = $("traderSide");
    const traderPfSummary = $("traderPfSummary");
    const traderPfTable   = $("traderPfTable");

    const buyBtn  = $("buyBtn");
    const sellBtn = $("sellBtn");
    const resetBtn = $("resetBtn");

    const historyTable = $("historyTable");

    /***** State *****/
    let me = null, myRole = null;
    let selectedId = null;
    let myTrader = null;
    let stocks = {};

    let chartType = "line";
    let series = [];
    let candleSeries = [];
    let lastSampleTime = 0;

    const TICK_MS = 1000;
    let lastProcessedTick = -1;
    let lastAutosTick = -1;

    const SEED_STOCKS = [
      "Reliance Industries","TCS","Infosys","HDFC Bank","ICICI Bank",
      "SBI","Bharti Airtel","HCL Technologies","Asian Paints","Wipro",
      "Tata Motors","Adani Enterprises","Hindustan Unilever","Larsen & Toubro","Bajaj Finance",
      "Kotak Mahindra Bank","UltraTech Cement","NTPC","JSW Steel","Tech Mahindra",
      "Power Grid","Adani Ports","Axis Bank","Maruti Suzuki","Grasim Industries"
    ];

    /***** Pricing helpers *****/
    function clamp(n){ return Math.max(1, Number.isFinite(n)? n : 0); }
    function currentPriceFor(stock){
      if (!stock) return 0;
      if (Number.isFinite(stock.price)) return stock.price;
      const base = Number.isFinite(stock.baseline) ? stock.baseline : (stock.defaultBaseline||500);
      return base;
    }
    function jumpOnce(stock){
      const base = Number.isFinite(stock.baseline) ? stock.baseline : (stock.defaultBaseline||500);
      if (stock.frozen) { stock.price = base; return; }
      const mag = 0.04 + Math.random()*0.01;
      const sign = Math.random() < 0.5 ? -1 : 1;
      const next = base * (1 + sign*mag);
      stock.price = Math.round(next * 100) / 100;
    }

    /***** Auth & Roles *****/
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ showLogin(); return; }
      me = user;

      let myRoleDoc = await getDoc(doc(db,"artifacts",APP_ID,"public","data","roles", user.uid));
      if (myRoleDoc.exists()){
        myRole = myRoleDoc.data().role;
      } else {
        const rolesCol = collection(db,"artifacts",APP_ID,"public","data","roles");
        const qEmail = query(rolesCol, where("email","==", user.email));
        const snap = await getDocs(qEmail);
        myRole = (!snap.empty) ? (snap.docs[0].data().role) : null;
      }
      if(!myRole){ showLogin("Role not found."); return; }

      roleHeader.textContent = `Welcome, ${myRole}`;

      const isAdmin = myRole === "admin";
      traderMetrics.classList.toggle("hidden", isAdmin);
      chartEl.classList.toggle("hidden", isAdmin);
      chartTypeRow.classList.toggle("hidden", isAdmin);
      tradeBar.classList.toggle("hidden", isAdmin);
      $("autoRow").classList.toggle("hidden", isAdmin);
      adminPortfolioView.classList.toggle("hidden", !isAdmin);
      adminSide.classList.toggle("hidden", !isAdmin);
      traderSide.classList.toggle("hidden", isAdmin);

      loginSection.classList.add("hidden");
      dashboard.classList.remove("hidden");

      await bootstrapStocks();
      attachRealtime();
      attachTraderDoc();
      if (isAdmin) { loadRankingsLoop(); fillTraderDropdown(); }

      startTickTimer();
      startAnimationLoop();
    });

    function showLogin(msg){
      dashboard.classList.add("hidden");
      loginSection.classList.remove("hidden");
      if (msg) loginError.textContent = msg;
    }

    /***** Stocks *****/
    function slug(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,"_"); }

    async function bootstrapStocks(){
      const col = collection(db,"artifacts",APP_ID,"public","data","stocks");
      const snap = await getDocs(col);

      const newStocks = {};
      const existingFirebaseSlugs = new Set();

      snap.forEach(d => {
        const data = d.data();
        const firebaseDocId = d.id;
        const stockName = data.name || firebaseDocId;
        const stockSlug = slug(stockName);

        const prev = newStocks[stockSlug] || {};
        const base = Number(data.baseline);

        newStocks[stockSlug] = {
          firebaseDocId: firebaseDocId,
          id: stockSlug,
          name: stockName,
          baseline: Number.isFinite(base) ? base : prev.baseline,
          price: Number.isFinite(prev.price) ? prev.price : (Number.isFinite(base) ? base : (prev.defaultBaseline || +(300 + Math.random()*900).toFixed(2))),
          defaultBaseline: prev.defaultBaseline || +(300 + Math.random()*900).toFixed(2),
          frozen: !!data.frozen
        };
        existingFirebaseSlugs.add(stockSlug);
      });

      for(const name of SEED_STOCKS){
        const stockSlug = slug(name);
        if (!newStocks[stockSlug]){
          const base = +(300+Math.random()*900).toFixed(2);
          newStocks[stockSlug] = {
            firebaseDocId: stockSlug,
            id: stockSlug,
            name,
            baseline: base,
            price: base,
            defaultBaseline: base,
            frozen:false
          };
        }

        if (!existingFirebaseSlugs.has(stockSlug)){
          try{
            await setDoc(doc(col,stockSlug), { name, baseline: newStocks[stockSlug].baseline, frozen:false }, { merge:true });
          }catch(_){ console.error("Error setting new stock in Firebase:", name); }
        }
      }
      stocks = newStocks;
    }

    function attachRealtime(){
      const col = collection(db,"artifacts",APP_ID,"public","data","stocks");
      onSnapshot(col, (snap)=>{
        const updatedStocks = {};
        const seenSlugs = new Set();

        snap.forEach(d => {
          const data = d.data()||{};
          const firebaseDocId = d.id;
          const stockName = data.name || firebaseDocId;
          const stockSlug = slug(stockName);
          seenSlugs.add(stockSlug);

          const prev = stocks[stockSlug] || {};
          const base = Number(data.baseline);
          const baselineChanged = Number.isFinite(prev.baseline) && Number.isFinite(base) && base !== prev.baseline;
          const priceInit = baselineChanged
              ? base
              : (Number.isFinite(prev.price) ? prev.price : (Number.isFinite(base) ? base : prev.defaultBaseline));

          updatedStocks[stockSlug] = {
            firebaseDocId: firebaseDocId,
            id: stockSlug,
            name: stockName,
            baseline: Number.isFinite(base) ? base : prev.baseline,
            price: clamp(priceInit),
            defaultBaseline: prev.defaultBaseline || +(300 + Math.random()*900).toFixed(2),
            frozen: !!data.frozen
          };
        });

        Object.values(stocks).forEach(s => {
          if (!seenSlugs.has(s.id)) {
            updatedStocks[s.id] = s;
          }
        });
        stocks = updatedStocks;

        renderStockTiles();
        if (selectedId && stocks[selectedId]) detailName.textContent = stocks[selectedId].name;
        else if (selectedId && !stocks[selectedId]) {
          selectedId = null;
          detailName.textContent = "Select a stock";
          detailPrice.textContent = "";
          adminSelected.textContent = "None";
          adminSelectedPrice.textContent = "";
        }
        updateTradeControls();
      });
    }

    function renderStockTiles(){
      stockList.innerHTML = "";
      Object.values(stocks).sort((a,b)=>a.name.localeCompare(b.name)).forEach(s => {
        const price = currentPriceFor(s);
        const tile = document.createElement("button");
        tile.className = "tile";
        tile.innerHTML = `<div class="name">${s.name}${s.frozen?' • <small style="color:#ffb3b3;font-weight:700">FROZEN</small>':''}</div><div class="price">₹ <span id="p-${s.id}">${fmt(price)}</span></div>`;
        tile.addEventListener("click", ()=>selectStock(s.id));
        stockList.appendChild(tile);
      });
    }

    function updateTradeControls(){
      const s = selectedId ? stocks[selectedId] : null;
      const isFrozen = !!s?.frozen;
      buyBtn.disabled = sellBtn.disabled = isFrozen || (myRole!=="trader");
      setAutoBtn.disabled = clearAutoBtn.disabled = isFrozen || (myRole!=="trader");
      tradeMsg.textContent = isFrozen ? "This stock is frozen. Trading disabled." : "";
    }

    function selectStock(id){
      selectedId = id;
      const s = stocks[id];
      detailName.textContent = s.name;
      series = [];
      candleSeries = [];
      lastSampleTime = 0;
      tradeMsg.textContent = "";
      adminSelected.textContent = s.name || "None";
      adminSelectedPrice.textContent = `• ₹ ${fmt(currentPriceFor(s))}${s.frozen?' • FROZEN':''}`;
      raiseBtn.disabled = lowerBtn.disabled = raise50Btn.disabled = lower50Btn.disabled = (myRole!=="admin");
      updateTradeControls();
      drawChart();
    }

    raiseBtn?.addEventListener("click", ()=> adjustSelected( 0.10));
    lowerBtn?.addEventListener("click", ()=> adjustSelected(-0.10));
    raise50Btn?.addEventListener("click", ()=> adjustSelected( 0.50));
    lower50Btn?.addEventListener("click", ()=> adjustSelected(-0.50));

    async function adjustSelected(delta){
      if(!selectedId || myRole!=="admin") return;
      const s = stocks[selectedId];
      const ref = doc(db,"artifacts",APP_ID,"public","data","stocks", s.firebaseDocId);
      const base = Number.isFinite(s.baseline) ? s.baseline : (s.defaultBaseline||500);
      const newBase = +(base * (1+delta)).toFixed(2);
      s.baseline = newBase; s.price = newBase;
      stocks[selectedId] = s;
      adminSelectedPrice.textContent = `• ₹ ${fmt(newBase)}${s.frozen?' • FROZEN':''}`;
      detailPrice.textContent = `₹ ${fmt(newBase)}${s.frozen?' • FROZEN':''}`;
      renderStockTiles();
      try{ await updateDoc(ref, { baseline:newBase }); }
      catch(err){ try{ await setDoc(ref, { name: s.name || selectedId, baseline: newBase }, { merge: true }); }catch(_){ } }
    }

    /***** Freeze / Unfreeze *****/
    freezeBtn?.addEventListener("click", async ()=>{
      if(!selectedId || myRole!=="admin") return;
      freezeMsg.textContent = "";
      const s = stocks[selectedId];
      const ref = doc(db,"artifacts",APP_ID,"public","data","stocks", s.firebaseDocId);
      try{
        await setDoc(ref, { name: s.name || selectedId, frozen: true }, { merge: true });
        s.frozen = true; stocks[selectedId] = s;
        freezeMsg.textContent = "Selected stock frozen.";
        updateTradeControls(); renderStockTiles();
      }catch(e){ freezeMsg.textContent = "Could not freeze stock."; }
    });

    unfreezeBtn?.addEventListener("click", async ()=>{
      if(!selectedId || myRole!=="admin") return;
      freezeMsg.textContent = "";
      const s = stocks[selectedId];
      const ref = doc(db,"artifacts",APP_ID,"public","data","stocks", s.firebaseDocId);
      try{
        await setDoc(ref, { name: s.name || selectedId, frozen: false }, { merge: true });
        s.frozen = false; stocks[selectedId] = s;
        freezeMsg.textContent = "Selected stock unfrozen.";
        updateTradeControls(); renderStockTiles();
      }catch(e){ freezeMsg.textContent = "Could not unfreeze stock."; }
    });

    freezeAllBtn?.addEventListener("click", async ()=>{
      if(myRole!=="admin") return;
      allFreezeMsg.textContent = "Freezing all stocks...";
      const stocksCol = collection(db,"artifacts",APP_ID,"public","data","stocks");
      try {
        const sSnap = await getDocs(stocksCol);
        for(const d of sSnap.docs){
          await updateDoc(d.ref, { frozen: true });
        }
        allFreezeMsg.textContent = "All stocks frozen.";
      } catch(e) {
        allFreezeMsg.textContent = "Could not freeze all stocks.";
      }
    });

    unfreezeAllBtn?.addEventListener("click", async ()=>{
      if(myRole!=="admin") return;
      allFreezeMsg.textContent = "Unfreezing all stocks...";
      const stocksCol = collection(db,"artifacts",APP_ID,"public","data","stocks");
      try {
        const sSnap = await getDocs(stocksCol);
        for(const d of sSnap.docs){
         await updateDoc(d.ref, { frozen: false });
        }
        allFreezeMsg.textContent = "All stocks unfrozen.";
      } catch(e) {
        allFreezeMsg.textContent = "Could not unfreeze all stocks.";
      }
    });
    
    /***** Trader Logic *****/
    function attachTraderDoc(){
        if(myRole !== "trader") return;
        const ref = doc(db,"artifacts",APP_ID,"public","data","traders",me.uid);
        onSnapshot(ref, (snap) => {
            myTrader = snap.exists() ? snap.data() : { funds: 0, portfolio: {}, history: [] };
            updateMetrics();
            renderTraderPortfolio();
        });
    }
    
    buyBtn?.addEventListener("click", async ()=>handleTrade("buy"));
    sellBtn?.addEventListener("click", async ()=>handleTrade("sell"));
    
    async function handleTrade(type){
        if(!selectedId || myRole !== "trader") return;
        const qty = parseInt(qtyEl.value, 10);
        if(!Number.isInteger(qty) || qty < 1){
            tradeMsg.textContent = "Invalid quantity.";
            return;
        }

        tradeMsg.textContent = "";
        const ref = doc(db,"artifacts",APP_ID,"public","data","traders",me.uid);
        
        try{
            await runTransaction(db, async (transaction) => {
                const traderDoc = await transaction.get(ref);
                const trader = traderDoc.exists() ? traderDoc.data() : { funds: 0, portfolio: {}, history: [] };
                const s = stocks[selectedId];
                const price = currentPriceFor(s);
                const cost = qty * price;

                if(type === "buy"){
                    if(trader.funds < cost){ throw new Error("Insufficient funds."); }
                    trader.funds -= cost;
                    trader.portfolio[selectedId] = (trader.portfolio[selectedId] || 0) + qty;
                } else { // sell
                    if(!trader.portfolio[selectedId] || trader.portfolio[selectedId] < qty){
                        throw new Error("Not enough shares to sell.");
                    }
                    trader.funds += cost;
                    trader.portfolio[selectedId] -= qty;
                    if(trader.portfolio[selectedId] === 0) delete trader.portfolio[selectedId];
                }

                trader.history.unshift({
                    time: Date.now(),
                    type,
                    stock: selectedId,
                    qty,
                    price,
                    value: cost
                });
                if(trader.history.length > 100) trader.history.pop();
                
                transaction.set(ref, trader, { merge: true });
            });
            tradeMsg.textContent = `Successfully ${type === "buy" ? "bought" : "sold"} ${qty} shares.`;

        } catch(e) {
            tradeMsg.textContent = e.message;
        }
    }
    
    setAutoBtn?.addEventListener("click", async () => {
        if(!selectedId || myRole !== "trader") return;
        const price = parseFloat(autoPrice.value);
        const qty = parseInt(autoQty.value, 10);
        if(!Number.isFinite(price) || price <= 0 || !Number.isInteger(qty) || qty < 1){
            autoMsg.textContent = "Invalid price or quantity.";
            return;
        }
        autoMsg.textContent = "";
        const ref = doc(db,"artifacts",APP_ID,"public","data","traders",me.uid);
        try{
            await updateDoc(ref, {
                [`autosell.${selectedId}`]: { price, qty }
            });
            autoMsg.textContent = "Auto-sell rule set.";
        } catch(e) {
            autoMsg.textContent = "Could not set rule.";
        }
    });

    clearAutoBtn?.addEventListener("click", async () => {
        if(!selectedId || myRole !== "trader") return;
        autoMsg.textContent = "";
        const ref = doc(db,"artifacts",APP_ID,"public","data","traders",me.uid);
        try{
            await updateDoc(ref, {
                [`autosell.${selectedId}`]: null
            });
            autoMsg.textContent = "Auto-sell rule cleared.";
        } catch(e){
             autoMsg.textContent = "Could not clear rule.";
        }
    });


    /***** Loops & Timers *****/
    function startTickTimer(){
      setInterval(() => {
        const now = Date.now();
        if (now - lastProcessedTick > TICK_MS) {
            processPriceTick();
            lastProcessedTick = now;
        }
         if (now - lastAutosTick > TICK_MS * 2) { // Less frequent
            processAutoSells();
            lastAutosTick = now;
        }
      }, TICK_MS / 2);
    }
    
    function processPriceTick(){
        Object.values(stocks).forEach(jumpOnce);
    }

    async function processAutoSells(){
        if(myRole !== 'trader' || !myTrader?.autosell) return;
        
        for(const stockId in myTrader.autosell){
            const rule = myTrader.autosell[stockId];
            if(!rule) continue;

            const s = stocks[stockId];
            if(!s || s.frozen) continue;
            
            const price = currentPriceFor(s);
            if(price >= rule.price){
                // Trigger sell
                const qtyToSell = Math.min(rule.qty, myTrader.portfolio[stockId] || 0);
                if(qtyToSell < 1) continue;

                const ref = doc(db,"artifacts",APP_ID,"public","data","traders",me.uid);
                try {
                     await runTransaction(db, async (transaction) => {
                        const traderDoc = await transaction.get(ref);
                        const t = traderDoc.data(); // fresh data
                        if(!t.portfolio[stockId] || t.portfolio[stockId] < qtyToSell) return;

                        const cost = qtyToSell * price;
                        t.funds += cost;
                        t.portfolio[stockId] -= qtyToSell;
                        if(t.portfolio[stockId] === 0) delete t.portfolio[stockId];
                        
                        t.history.unshift({ time: Date.now(), type: 'auto-sell', stock: stockId, qty: qtyToSell, price, value: cost });
                        delete t.autosell[stockId]; // remove rule after execution
                        transaction.set(ref, t);
                    });
                } catch(e){ console.error("Auto-sell failed:", e); }
            }
        }
    }

    function startAnimationLoop(){
      requestAnimationFrame(function animate(){
        if(selectedId){
          const s = stocks[selectedId];
          const price = currentPriceFor(s);
          detailPrice.textContent = `₹ ${fmt(price)}${s.frozen?' • FROZEN':''}`;
          adminSelectedPrice.textContent = `• ₹ ${fmt(price)}${s.frozen?' • FROZEN':''}`;
          
          if(Date.now() - lastSampleTime > 1000){
            series.push(price);
            if(series.length > 50) series.shift();
            
            // For candle chart
            if (candleSeries.length === 0 || Date.now() - candleSeries[candleSeries.length-1].time > 5000) {
                candleSeries.push({ open: price, high: price, low: price, close: price, time: Date.now() });
            } else {
                let lastCandle = candleSeries[candleSeries.length - 1];
                lastCandle.high = Math.max(lastCandle.high, price);
                lastCandle.low = Math.min(lastCandle.low, price);
                lastCandle.close = price;
            }
            if(candleSeries.length > 30) candleSeries.shift();

            lastSampleTime = Date.now();
            drawChart();
          }
        }
        Object.values(stocks).forEach(s=>{
          const el = $(`p-${s.id}`);
          if(el) el.textContent = fmt(currentPriceFor(s));
        });
        updateMetrics();
        requestAnimationFrame(animate);
      });
    }

    function updateMetrics(){
        if(myRole !== "trader" || !myTrader) return;

        workingCapEl.textContent = fmt(myTrader.funds);

        let invested = 0;
        let initialInvested = myTrader.initialFunds || 100000;
        for(const stockId in myTrader.portfolio){
            const qty = myTrader.portfolio[stockId];
            invested += qty * currentPriceFor(stocks[stockId]);
        }
        investedCapEl.textContent = fmt(invested);

        const totalEquity = myTrader.funds + invested;
        const pl = ((totalEquity - initialInvested) / initialInvested) * 100;
        profitLossEl.textContent = `${fmt(pl)}%`;
        profitLossEl.style.color = pl >= 0 ? 'var(--good)' : 'var(--bad)';
    }
    
    function renderTraderPortfolio(){
        if(myRole !== "trader" || !myTrader) return;
        traderPfTable.innerHTML = "";
        let totalValue = 0;
        Object.keys(myTrader.portfolio).sort().forEach(stockId => {
            const qty = myTrader.portfolio[stockId];
            if(qty < 1) return;
            const s = stocks[stockId];
            if(!s) return;
            const price = currentPriceFor(s);
            const value = qty * price;
            totalValue += value;
            const row = document.createElement("tr");
            row.innerHTML = `<td>${s.name}</td><td>${qty}</td><td>${fmt(price)}</td><td>${fmt(value)}</td>`;
            traderPfTable.appendChild(row);
        });
        traderPfSummary.textContent = `Total Value: ₹ ${fmt(totalValue)}`;
    }


    /***** Graphing *****/
    const lineGraphBtn = $("lineGraphBtn");
    const candleGraphBtn = $("candleGraphBtn");

    lineGraphBtn.addEventListener("click", () => {
      chartType = "line";
      lineGraphBtn.classList.add("btn-primary");
      lineGraphBtn.classList.remove("btn-ghost");
      candleGraphBtn.classList.add("btn-ghost");
      candleGraphBtn.classList.remove("btn-primary");
      drawChart();
    });

    candleGraphBtn.addEventListener("click", () => {
      chartType = "candle";
      candleGraphBtn.classList.add("btn-primary");
      candleGraphBtn.classList.remove("btn-ghost");
      lineGraphBtn.classList.add("btn-ghost");
      lineGraphBtn.classList.remove("btn-primary");
      drawChart();
    });

    function drawChart(){
      if(myRole !== 'trader' || !selectedId) return;
      if (chartType === "line") drawLineChart();
      else if (chartType === "candle") drawCandleChart();
    }

    function drawLineChart(){
      const ctx = chartEl.getContext("2d");
      const { width, height } = chartEl;
      ctx.clearRect(0,0,width,height);

      if (series.length < 2) return;

      const min = Math.min(...series);
      const max = Math.max(...series);
      const range = max === min ? 1 : max - min;
      const xStep = width / (series.length - 1);

      ctx.beginPath();
      ctx.strokeStyle = "var(--accent)";
      ctx.lineWidth = 2;
      ctx.lineJoin = "round";

      series.forEach((price, i) => {
        const y = height - ((price - min) / range * height * 0.9 + height * 0.05);
        if (i === 0) ctx.moveTo(i * xStep, y);
        else ctx.lineTo(i * xStep, y);
      });
      ctx.stroke();
    }

    function drawCandleChart() {
      const ctx = chartEl.getContext("2d");
      const { width, height } = chartEl;
      ctx.clearRect(0,0,width,height);

      if (candleSeries.length < 1) return;

      const allPrices = candleSeries.flatMap(c => [c.high, c.low]);
      const min = Math.min(...allPrices);
      const max = Math.max(...allPrices);
      const range = max === min ? 1 : max - min;
      
      const candleWidth = Math.max(3, width / candleSeries.length * 0.7);
      const xStep = width / candleSeries.length;

      candleSeries.forEach((c, i) => {
        const y = (price) => height - ((price - min) / range * height * 0.9 + height * 0.05);

        const yOpen = y(c.open);
        const yClose = y(c.close);
        const yHigh = y(c.high);
        const yLow = y(c.low);
        
        const color = c.close >= c.open ? 'var(--good)' : 'var(--bad)';
        ctx.strokeStyle = color;
        ctx.fillStyle = color;

        // Wick
        ctx.beginPath();
        ctx.moveTo(i * xStep + xStep/2, yHigh);
        ctx.lineTo(i * xStep + xStep/2, yLow);
        ctx.lineWidth = 1;
        ctx.stroke();

        // Body
        ctx.fillRect(i * xStep + (xStep-candleWidth)/2, Math.min(yOpen, yClose), candleWidth, Math.abs(yOpen - yClose) || 1);
      });
    }

    /***** Admin *****/
    applyFundsBtn?.addEventListener("click", async ()=>{
        if(myRole !== "admin") return;
        const funds = parseFloat(allFunds.value);
        if(!Number.isFinite(funds) || funds < 0){
            fundsMsg.textContent = "Invalid amount.";
            return;
        }
        fundsMsg.textContent = "Applying...";
        const tradersCol = collection(db, "artifacts", APP_ID, "public", "data", "traders");
        try {
            const snap = await getDocs(tradersCol);
            for(const d of snap.docs){
                await updateDoc(d.ref, { funds: funds, initialFunds: funds });
            }
            fundsMsg.textContent = `Set starting funds to ${fmt(funds)} for all traders.`;
        } catch(e) {
            fundsMsg.textContent = "Could not apply funds.";
        }
    });
    
    resetBtn?.addEventListener("click", async ()=>{
        if(myRole !== "admin" || !confirm("HARD RESET: Are you sure you want to reset all stocks and trader data? This cannot be undone.")) return;
        
        // Reset stocks
        const stocksCol = collection(db, "artifacts", APP_ID, "public", "data", "stocks");
        const sSnap = await getDocs(stocksCol);
        for(const d of sSnap.docs) await updateDoc(d.ref, { baseline: null, frozen: false });
        await bootstrapStocks();
        
        // Reset traders
        const tradersCol = collection(db, "artifacts", APP_ID, "public", "data", "traders");
        const tSnap = await getDocs(tradersCol);
        for(const d of tSnap.docs) await setDoc(d.ref, { funds: 100000, initialFunds: 100000, portfolio: {}, history: [], autosell: {} });
        
        alert("System has been hard reset.");
    });
    
    async function loadRankingsLoop(){
        if(myRole !== "admin") return;
        
        async function updateRanks(){
            const tradersCol = collection(db,"artifacts",APP_ID,"public","data","traders");
            const rolesCol = collection(db,"artifacts",APP_ID,"public","data","roles");
            
            const [tradersSnap, rolesSnap] = await Promise.all([getDocs(tradersCol), getDocs(rolesCol)]);
            
            const rolesByUid = {};
            rolesSnap.forEach(d => { rolesByUid[d.id] = d.data(); });
            
            const ranks = [];
            tradersSnap.forEach(d => {
                const trader = d.data();
                const uid = d.id;
                let invested = 0;
                for(const stockId in trader.portfolio){
                    invested += (trader.portfolio[stockId] || 0) * currentPriceFor(stocks[stockId]);
                }
                const totalEquity = (trader.funds || 0) + invested;
                const initial = trader.initialFunds || 100000;
                const pl = ((totalEquity - initial) / initial) * 100;
                
                ranks.push({
                    name: rolesByUid[uid]?.email.split('@')[0] || uid.slice(0,6),
                    equity: totalEquity,
                    pl
                });
            });

            ranks.sort((a,b) => b.equity - a.equity);
            
            rankTable.innerHTML = "";
            ranks.forEach((r, i) => {
                const row = document.createElement("tr");
                row.innerHTML = `<td>${i+1}</td><td>${r.name}</td><td>${fmt(r.equity)}</td><td style="color:${r.pl >= 0 ? 'var(--good)':'var(--bad)'}">${fmt(r.pl)}%</td>`;
                rankTable.appendChild(row);
            });
        }
        
        await updateRanks();
        setInterval(updateRanks, 5000);
    }
    
    async function fillTraderDropdown(){
        const rolesCol = collection(db,"artifacts",APP_ID,"public","data","roles");
        const q = query(rolesCol, where("role", "==", "trader"));
        const snap = await getDocs(q);
        traderSelect.innerHTML = `<option value="">Select a trader to view portfolio</option>`;
        snap.forEach(d => {
            const opt = document.createElement("option");
            opt.value = d.id;
            opt.textContent = d.data().email;
            traderSelect.appendChild(opt);
        });
    }

    traderSelect?.addEventListener("change", async (e) => {
        const uid = e.target.value;
        if(!uid){
            portfolioWrap.style.display = "none";
            return;
        }
        
        const ref = doc(db,"artifacts",APP_ID,"public","data","traders",uid);
        const d = await getDoc(ref);
        if(!d.exists()){
            portfolioWrap.style.display = "none";
            return;
        }
        
        const trader = d.data();
        const email = traderSelect.options[traderSelect.selectedIndex].text;
        pfTitle.textContent = `Portfolio for ${email}`;
        
        pfTable.innerHTML = "";
        let totalValue = 0;
        for(const stockId in trader.portfolio){
            const qty = trader.portfolio[stockId];
            if(qty < 1) continue;
            const s = stocks[stockId];
            if(!s) continue;
            const price = currentPriceFor(s);
            const value = qty * price;
            totalValue += value;
            const row = document.createElement("tr");
            row.innerHTML = `<td>${s.name}</td><td>${qty}</td><td>${fmt(price)}</td><td>${fmt(value)}</td>`;
            pfTable.appendChild(row);
        }
        pfSummary.innerHTML = `<strong>Funds:</strong> ${fmt(trader.funds)} &nbsp; • &nbsp; <strong>Invested:</strong> ${fmt(totalValue)} &nbsp; • &nbsp; <strong>Total:</strong> ${fmt(trader.funds + totalValue)}`;
        
        historyTable.innerHTML = "";
        (trader.history || []).forEach(h => {
           const row = document.createElement("tr");
           row.innerHTML = `<td>${new Date(h.time).toLocaleTimeString()}</td><td>${h.type}</td><td>${stocks[h.stock]?.name||h.stock}</td><td>${h.qty}</td><td>${fmt(h.price)}</td><td>${fmt(h.value)}</td>`;
           historyTable.appendChild(row);
        });
        
        portfolioWrap.style.display = "block";
    });

    /***** Utils *****/
    function fmt(n){
      return (n || 0).toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2});
    }

  </script>
</body>
</html>

